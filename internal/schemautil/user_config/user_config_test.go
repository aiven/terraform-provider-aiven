// TODO: Add build tags.

package user_config

import (
	"fmt"
	"testing"

	"github.com/aiven/aiven-go-client/tools/exp/dist"
	"github.com/dave/jennifer/jen"
	"github.com/ettle/strcase"
	"golang.org/x/exp/maps"
	"golang.org/x/exp/slices"
	"gopkg.in/yaml.v3"
)

// generateSchema is a function that generates Terraform schema via its map representation.
func generateSchema(n string, m map[string]interface{}) {
	np := fmt.Sprintf("%ss", n)

	f := jen.NewFile("user_config")

	f.HeaderComment("Code generated by internal/schemautil/user_config/user_config_test.go; DO NOT EDIT.")

	smk := maps.Keys(m)
	slices.Sort(smk)

	for _, k := range smk {
		v := m[k]

		kp := strcase.ToGoPascal(k)

		va, ok := v.(map[string]interface{})
		if !ok {
			continue
		}

		pa, ok := va["properties"].(map[string]interface{})
		if !ok {
			continue
		}

		fn := fmt.Sprintf("%s%s", n, kp)

		f.Commentf("%s is a generated function returning the schema of the %s %s.", fn, k, n)

		f.
			Func().
			Id(fn).
			Params().
			Id("*schema.Schema").
			Block(
				jen.Id("s").Op(":=").Map(jen.String()).Op("*").Qual(SchemaPackage, "Schema").Values(
					convertPropertiesToSchemaMap(pa),
				),

				jen.Line(),

				jen.Return(
					jen.Op("&").Qual(SchemaPackage, "Schema").Values(jen.Dict{
						jen.Id("Type"):        jen.Qual(SchemaPackage, "TypeList"),
						jen.Id("Description"): jen.Lit(fmt.Sprintf("%s user configurable settings", kp)),
						jen.Id("Elem"): jen.Op("&").Qual(SchemaPackage, "Resource").Values(jen.Dict{
							jen.Id("Schema"): jen.Id("s"),
						}),
						jen.Id("Optional"): jen.Lit(true),
						jen.Id("DiffSuppressFunc"): jen.
							Qual(SchemaUtilPackage, "EmptyObjectDiffSuppressFuncSkipArrays").Call(jen.Id("s")),
						jen.Id("MaxItems"): jen.Lit(1),
					}),
				),
			).
			Line()
	}

	if err := f.Save(fmt.Sprintf("%s.go", strcase.ToSnake(np))); err != nil {
		panic(err)
	}
}

// representationToMap converts a YAML representation of a Terraform schema to a map.
func representationToMap(r []byte) map[string]interface{} {
	var m map[string]interface{}

	if err := yaml.Unmarshal(r, &m); err != nil {
		panic(err)
	}

	return m
}

// TestMain is the entry point for the user config schema generator.
func TestMain(m *testing.M) {
	generateSchema("ServiceType", representationToMap(dist.ServiceTypes))

	generateSchema("IntegrationType", representationToMap(dist.IntegrationTypes))

	generateSchema("IntegrationEndpointType", representationToMap(dist.IntegrationEndpointTypes))
}
