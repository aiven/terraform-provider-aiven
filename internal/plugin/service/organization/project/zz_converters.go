// Copyright (c) 2025 Aiven, Helsinki, Finland. https://aiven.io/
// Code generated by user config generator. DO NOT EDIT.

package project

import (
	"context"
	"fmt"
	"path/filepath"
	"strings"

	"github.com/hashicorp/terraform-plugin-framework/attr"
	"github.com/hashicorp/terraform-plugin-framework/diag"
	"github.com/hashicorp/terraform-plugin-framework/types"

	"github.com/aiven/terraform-provider-aiven/internal/plugin/util"
)

func idFields() []string {
	return []string{"organization_id", "project_id"}
}

// dataModel Gets information about an Aiven project.
type dataModel struct {
	ID              types.String `tfsdk:"id"`
	BasePort        types.Int64  `tfsdk:"base_port"`
	BillingGroupID  types.String `tfsdk:"billing_group_id"`
	CaCert          types.String `tfsdk:"ca_cert"`
	OrganizationID  types.String `tfsdk:"organization_id"`
	ParentID        types.String `tfsdk:"parent_id"`
	ProjectID       types.String `tfsdk:"project_id"`
	Tag             types.Set    `tfsdk:"tag"`
	TechnicalEmails types.Set    `tfsdk:"technical_emails"`
}

func (data *dataModel) SetID(vOrganizationID string, vProjectID string) {
	data.OrganizationID = types.StringValue(vOrganizationID)
	data.ProjectID = types.StringValue(vProjectID)
	data.ID = types.StringValue(filepath.Join(vOrganizationID, vProjectID))
}

// dataTag
type dataTag struct {
	Key   types.String `tfsdk:"key"`
	Value types.String `tfsdk:"value"`
}

type dtoModel struct {
	BasePort        *int64     `json:"base_port,omitempty"`
	BillingGroupID  *string    `json:"billing_group_id,omitempty"`
	CaCert          *string    `json:"certificate,omitempty"`
	OrganizationID  *string    `json:"organization_id,omitempty"`
	ParentID        *string    `json:"parent_id,omitempty"`
	ProjectID       *string    `json:"project_id,omitempty"`
	Tag             *[]*dtoTag `json:"tags,omitempty"`
	TechnicalEmails *[]string  `json:"tech_emails,omitempty"`
}

type dtoTag struct {
	Key   *string `json:"key,omitempty"`
	Value *string `json:"value,omitempty"`
}

// expandData turns TF object into Request
func expandData[R any](ctx context.Context, plan, state *dataModel, rqs *R, modifiers ...util.MapModifier[dtoModel]) diag.Diagnostics {
	dto := new(dtoModel)
	if !plan.Tag.IsNull() || state != nil && !state.Tag.IsNull() {
		vTag, diags := util.ExpandSetNested(ctx, expandTag, plan.Tag)
		if diags.HasError() {
			return diags
		}
		dto.Tag = &vTag
	}
	if !plan.TechnicalEmails.IsNull() || state != nil && !state.TechnicalEmails.IsNull() {
		vTechnicalEmails := make([]string, 0)
		diags := plan.TechnicalEmails.ElementsAs(ctx, &vTechnicalEmails, false)
		if diags.HasError() {
			return diags
		}
		dto.TechnicalEmails = &vTechnicalEmails
	}
	if !plan.BasePort.IsNull() && !plan.BasePort.IsUnknown() {
		vBasePort := plan.BasePort.ValueInt64()
		dto.BasePort = &vBasePort
	}
	if !plan.BillingGroupID.IsNull() || state != nil && !state.BillingGroupID.IsNull() {
		vBillingGroupID := plan.BillingGroupID.ValueString()
		dto.BillingGroupID = &vBillingGroupID
	}
	if !plan.OrganizationID.IsNull() || state != nil && !state.OrganizationID.IsNull() {
		vOrganizationID := plan.OrganizationID.ValueString()
		dto.OrganizationID = &vOrganizationID
	}
	if !plan.ParentID.IsNull() || state != nil && !state.ParentID.IsNull() {
		vParentID := plan.ParentID.ValueString()
		dto.ParentID = &vParentID
	}
	if !plan.ProjectID.IsNull() || state != nil && !state.ProjectID.IsNull() {
		vProjectID := plan.ProjectID.ValueString()
		dto.ProjectID = &vProjectID
	}
	err := util.Unmarshal(dto, rqs, modifiers...)
	if err != nil {
		var diags diag.Diagnostics
		diags.AddError("Unmarshal error", fmt.Sprintf("Failed to unmarshal dtoModel to Request: %s", err.Error()))
		return diags
	}
	return nil
}

func expandTag(ctx context.Context, plan *dataTag) (*dtoTag, diag.Diagnostics) {
	dto := new(dtoTag)
	if !plan.Key.IsNull() {
		vKey := plan.Key.ValueString()
		dto.Key = &vKey
	}
	if !plan.Value.IsNull() {
		vValue := plan.Value.ValueString()
		dto.Value = &vValue
	}
	return dto, nil
}

// flattenData turns Response into TF object
func flattenData[R any](ctx context.Context, state *dataModel, rsp *R, modifiers ...util.MapModifier[R]) diag.Diagnostics {
	dto := new(dtoModel)
	err := util.Unmarshal(rsp, dto, modifiers...)
	if err != nil {
		var diags diag.Diagnostics
		diags.AddError("Unmarshal error", fmt.Sprintf("Failed to unmarshal Response to dtoModel: %s", err.Error()))
		return diags
	}
	if dto.Tag != nil {
		vTag, diags := util.FlattenSetNested(ctx, flattenTag, *dto.Tag, attrsTag())
		if diags.HasError() {
			return diags
		}
		state.Tag = vTag
	}
	if dto.TechnicalEmails != nil && (len(*dto.TechnicalEmails) > 0 || !state.TechnicalEmails.IsNull()) {
		vTechnicalEmails, diags := types.SetValueFrom(ctx, types.StringType, dto.TechnicalEmails)
		if diags.HasError() {
			return diags
		}
		state.TechnicalEmails = vTechnicalEmails
	}
	if dto.BasePort != nil {
		state.BasePort = types.Int64PointerValue(dto.BasePort)
	}
	if dto.BillingGroupID != nil && (*dto.BillingGroupID != "" || !state.BillingGroupID.IsNull()) {
		state.BillingGroupID = types.StringPointerValue(dto.BillingGroupID)
	}
	if dto.CaCert != nil && (*dto.CaCert != "" || !state.CaCert.IsNull()) {
		state.CaCert = types.StringPointerValue(dto.CaCert)
	}
	if dto.OrganizationID != nil && (*dto.OrganizationID != "" || !state.OrganizationID.IsNull()) {
		state.OrganizationID = types.StringPointerValue(dto.OrganizationID)
	}
	if dto.ParentID != nil && (*dto.ParentID != "" || !state.ParentID.IsNull()) {
		state.ParentID = types.StringPointerValue(dto.ParentID)
	}
	if dto.ProjectID != nil && (*dto.ProjectID != "" || !state.ProjectID.IsNull()) {
		state.ProjectID = types.StringPointerValue(dto.ProjectID)
	}
	// Response may not contain ID fields.
	// In that case, `terraform import` won't be able to set them. Gets values from the ID.
	if state.ID.ValueString() != "" {
		var parts [2]string
		for i, v := range strings.SplitN(state.ID.ValueString(), "/", 2) {
			parts[i] = v
		}
		if state.OrganizationID.ValueString() == "" {
			state.OrganizationID = types.StringValue(parts[0])
		}
		if state.ProjectID.ValueString() == "" {
			state.ProjectID = types.StringValue(parts[1])
		}
	}
	state.SetID(state.OrganizationID.ValueString(), state.ProjectID.ValueString())
	return nil
}

func flattenTag(ctx context.Context, dto *dtoTag) (*dataTag, diag.Diagnostics) {
	state := new(dataTag)
	if dto.Key != nil {
		state.Key = types.StringPointerValue(dto.Key)
	}
	if dto.Value != nil {
		state.Value = types.StringPointerValue(dto.Value)
	}
	return state, nil
}

func attrsTag() types.ObjectType {
	return types.ObjectType{AttrTypes: map[string]attr.Type{
		"key":   types.StringType,
		"value": types.StringType,
	}}
}
